// =============================================================================
// ALPHATIC - ROTH CONVERSION TAB COMPONENT
// =============================================================================
// Displays Roth conversion timeline, tax costs, and projections
// Auto-recalculates when IRA balance or conversion settings change
// =============================================================================

import React, { useMemo } from 'react';
import { calculateRothProjections } from '../../utils/rothProjections';
import { formatCurrency, formatPercent } from '../../utils/formatters';
import { TAX_BRACKETS_2024 } from '../../data/constants';

const RothTab = ({ 
  iraAmount,
  rothAmount,
  currentAge = 60,
  targetAge = 73,
  continueAfterRMD = false,
  frontLoadConversions = false,
  annualSpending = 200000
}) => {
  
  // Calculate Roth conversion projections
  const rothProjections = useMemo(() => {
    const projections = calculateRothProjections({
      currentIRABalance: iraAmount,
      currentRothBalance: rothAmount,
      currentAge,
      targetAge: continueAfterRMD ? 80 : targetAge,
      frontLoadConversions,
      annualSpending
    });
    
    return projections;
  }, [iraAmount, rothAmount, currentAge, targetAge, continueAfterRMD, frontLoadConversions, annualSpending]);

  // Calculate summary statistics
  const summary = useMemo(() => {
    if (!rothProjections || rothProjections.length === 0) {
      return null;
    }

    const totalConversions = rothProjections.reduce((sum, year) => sum + year.conversionAmount, 0);
    const totalTaxes = rothProjections.reduce((sum, year) => sum + year.taxOnConversion, 0);
    const yearsToConvert = rothProjections.filter(y => y.conversionAmount > 0).length;
    const finalRothBalance = rothProjections[rothProjections.length - 1]?.endingRothBalance || 0;
    const finalTraditionalBalance = rothProjections[rothProjections.length - 1]?.endingIRABalance || 0;
    
    // Find peak tax year
    const peakTaxYear = rothProjections.reduce((max, year) => 
      year.taxOnConversion > max.taxOnConversion ? year : max
    , rothProjections[0]);
    
    return {
      totalConversions,
      totalTaxes,
      yearsToConvert,
      finalRothBalance,
      finalTraditionalBalance,
      averageAnnualConversion: totalConversions / yearsToConvert,
      averageAnnualTax: totalTaxes / yearsToConvert,
      effectiveTaxRate: (totalTaxes / totalConversions) * 100,
      peakTaxYear: peakTaxYear.year,
      peakTaxAmount: peakTaxYear.taxOnConversion
    };
  }, [rothProjections]);

  if (!summary) {
    return (
      <div className="bg-yellow-900/20 border border-yellow-600/30 rounded-lg p-6">
        <div className="flex items-center gap-3 mb-3">
          <span className="text-3xl">‚ö†Ô∏è</span>
          <h3 className="text-xl font-semibold text-yellow-400">Unable to Calculate Projections</h3>
        </div>
        <p className="text-slate-300">
          Please check your IRA balance and conversion settings.
        </p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold mb-4">Roth Conversion Strategy</h2>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="bg-gradient-to-br from-purple-900/20 to-pink-900/20 rounded-lg p-4 border border-purple-500/30">
          <div className="text-sm text-slate-400 mb-1">Total Conversions</div>
          <div className="text-2xl font-bold text-purple-400">
            {formatCurrency(summary.totalConversions)}
          </div>
          <div className="text-xs text-slate-500 mt-1">
            Over {summary.yearsToConvert} years
          </div>
        </div>

        <div className="bg-gradient-to-br from-orange-900/20 to-red-900/20 rounded-lg p-4 border border-orange-500/30">
          <div className="text-sm text-slate-400 mb-1">Total Tax Cost</div>
          <div className="text-2xl font-bold text-orange-400">
            {formatCurrency(summary.totalTaxes)}
          </div>
          <div className="text-xs text-slate-500 mt-1">
            {formatPercent(summary.effectiveTaxRate)} effective rate
          </div>
        </div>

        <div className="bg-gradient-to-br from-cyan-900/20 to-blue-900/20 rounded-lg p-4 border border-cyan-500/30">
          <div className="text-sm text-slate-400 mb-1">Final Roth Balance</div>
          <div className="text-2xl font-bold text-cyan-400">
            {formatCurrency(summary.finalRothBalance)}
          </div>
          <div className="text-xs text-slate-500 mt-1">
            Tax-free forever
          </div>
        </div>

        <div className="bg-gradient-to-br from-green-900/20 to-emerald-900/20 rounded-lg p-4 border border-green-500/30">
          <div className="text-sm text-slate-400 mb-1">Annual Average</div>
          <div className="text-2xl font-bold text-green-400">
            {formatCurrency(summary.averageAnnualConversion)}
          </div>
          <div className="text-xs text-slate-500 mt-1">
            {formatCurrency(summary.averageAnnualTax)} tax/year
          </div>
        </div>
      </div>

      {/* Conversion Strategy Info */}
      <div className="bg-blue-900/20 border border-blue-600/30 rounded-lg p-4">
        <h3 className="text-lg font-semibold mb-2 text-blue-400">Your Conversion Strategy</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-300">
          <div>
            <div className="font-semibold mb-2">Timeline:</div>
            <ul className="space-y-1 text-xs">
              <li>‚Ä¢ Starting Age: {currentAge}</li>
              <li>‚Ä¢ Target Completion: Age {continueAfterRMD ? 80 : targetAge}</li>
              <li>‚Ä¢ Conversion Years: {summary.yearsToConvert}</li>
              <li>‚Ä¢ Strategy: {frontLoadConversions ? 'Front-loaded (higher early conversions)' : 'Even distribution'}</li>
            </ul>
          </div>
          <div>
            <div className="font-semibold mb-2">Tax Efficiency:</div>
            <ul className="space-y-1 text-xs">
              <li>‚Ä¢ Effective Tax Rate: {formatPercent(summary.effectiveTaxRate)}</li>
              <li>‚Ä¢ Peak Tax Year: {summary.peakTaxYear} ({formatCurrency(summary.peakTaxAmount)})</li>
              <li>‚Ä¢ Average Annual Tax: {formatCurrency(summary.averageAnnualTax)}</li>
              <li>‚Ä¢ Total Tax Investment: {formatCurrency(summary.totalTaxes)}</li>
            </ul>
          </div>
        </div>
      </div>

      {/* Year-by-Year Conversion Timeline */}
      <div className="bg-slate-800/50 rounded-lg p-6 border border-slate-600/30">
        <h3 className="text-lg font-semibold mb-4 text-slate-200">Year-by-Year Conversion Timeline</h3>
        
        <div className="space-y-2 max-h-96 overflow-y-auto">
          {rothProjections.filter(year => year.conversionAmount > 0).map((year) => (
            <div key={year.year} className="bg-slate-700/50 rounded p-4">
              <div className="flex justify-between items-start mb-3">
                <div>
                  <div className="font-semibold text-blue-400">Year {year.year}</div>
                  <div className="text-xs text-slate-400">Age {year.age}</div>
                </div>
                <div className="text-right">
                  <div className="font-semibold text-purple-400">
                    Convert: {formatCurrency(year.conversionAmount)}
                  </div>
                  <div className="text-xs text-orange-400">
                    Tax: {formatCurrency(year.taxOnConversion)}
                  </div>
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-3 text-xs">
                <div>
                  <div className="text-slate-500 mb-1">Traditional IRA:</div>
                  <div className="flex justify-between text-slate-300">
                    <span>Start:</span>
                    <span>{formatCurrency(year.startingIRABalance)}</span>
                  </div>
                  <div className="flex justify-between text-slate-300">
                    <span>End:</span>
                    <span>{formatCurrency(year.endingIRABalance)}</span>
                  </div>
                </div>
                <div>
                  <div className="text-slate-500 mb-1">Roth IRA:</div>
                  <div className="flex justify-between text-slate-300">
                    <span>Start:</span>
                    <span>{formatCurrency(year.startingRothBalance)}</span>
                  </div>
                  <div className="flex justify-between text-cyan-300">
                    <span>End:</span>
                    <span>{formatCurrency(year.endingRothBalance)}</span>
                  </div>
                </div>
              </div>

              {year.marginalTaxBracket && (
                <div className="mt-2 pt-2 border-t border-slate-600">
                  <div className="text-xs text-slate-400">
                    Marginal Tax Bracket: {formatPercent(year.marginalTaxBracket)} 
                    {year.inTopBracket && <span className="text-red-400 ml-2">‚ö†Ô∏è Top bracket</span>}
                  </div>
                </div>
              )}

              {/* Progress bar */}
              <div className="mt-3">
                <div className="flex justify-between text-xs text-slate-400 mb-1">
                  <span>Conversion Progress</span>
                  <span>{formatPercent((year.endingRothBalance / (iraAmount + rothAmount)) * 100)}</span>
                </div>
                <div className="w-full bg-slate-600 rounded h-2">
                  <div 
                    className="bg-cyan-500 h-2 rounded"
                    style={{ width: `${Math.min(100, (year.endingRothBalance / (iraAmount + rothAmount)) * 100)}%` }}
                  />
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Tax Bracket Strategy */}
      <div className="bg-gradient-to-r from-slate-800/50 to-slate-700/50 rounded-lg p-6 border border-slate-600/30">
        <h3 className="text-lg font-semibold mb-4 text-slate-200">Tax Bracket Optimization</h3>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h4 className="text-sm font-semibold text-green-400 mb-3">Current Tax Brackets (2024)</h4>
            <div className="space-y-2 text-xs">
              {Object.entries(TAX_BRACKETS_2024.married).map(([rate, threshold]) => (
                <div key={rate} className="flex justify-between">
                  <span className="text-slate-400">{formatPercent(parseFloat(rate) * 100)}:</span>
                  <span className="text-slate-200">Income over {formatCurrency(threshold)}</span>
                </div>
              ))}
            </div>
          </div>

          <div>
            <h4 className="text-sm font-semibold text-orange-400 mb-3">Strategy Notes</h4>
            <ul className="space-y-2 text-xs text-slate-300">
              <li className="flex items-start">
                <span className="text-green-400 mr-2">‚úì</span>
                <span>Converting to top of 24% bracket maximizes efficiency</span>
              </li>
              <li className="flex items-start">
                <span className="text-yellow-400 mr-2">‚ö†</span>
                <span>Avoid 32% and higher brackets if possible</span>
              </li>
              <li className="flex items-start">
                <span className="text-blue-400 mr-2">üí°</span>
                <span>RMDs start at age 73 - convert before then</span>
              </li>
              <li className="flex items-start">
                <span className="text-purple-400 mr-2">üìä</span>
                <span>Consider Medicare IRMAA thresholds</span>
              </li>
            </ul>
          </div>
        </div>
      </div>

      {/* Benefits of Roth Conversion */}
      <div className="bg-purple-900/20 border border-purple-600/30 rounded-lg p-4">
        <h4 className="font-semibold text-purple-400 mb-3">üíé Benefits of Roth Conversion</h4>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-slate-300">
          <div>
            <div className="font-semibold mb-2 text-cyan-400">Tax-Free Growth:</div>
            <ul className="space-y-1 text-xs list-disc list-inside">
              <li>All future gains tax-free</li>
              <li>Tax-free withdrawals in retirement</li>
              <li>No taxes on inheritance</li>
              <li>Hedge against higher future tax rates</li>
            </ul>
          </div>
          <div>
            <div className="font-semibold mb-2 text-green-400">No RMDs:</div>
            <ul className="space-y-1 text-xs list-disc list-inside">
              <li>No required minimum distributions</li>
              <li>Money grows tax-free indefinitely</li>
              <li>Better estate planning tool</li>
              <li>More control over withdrawals</li>
            </ul>
          </div>
          <div>
            <div className="font-semibold mb-2 text-blue-400">Medicare Benefits:</div>
            <ul className="space-y-1 text-xs list-disc list-inside">
              <li>Lower MAGI = lower IRMAA premiums</li>
              <li>Roth withdrawals don't count as income</li>
              <li>Avoid Medicare surcharges</li>
              <li>Save thousands annually on premiums</li>
            </ul>
          </div>
        </div>
      </div>

      {/* Implementation Tips */}
      <div className="bg-blue-900/20 border border-blue-600/30 rounded-lg p-4">
        <h4 className="font-semibold text-blue-400 mb-3">üéØ Implementation Tips</h4>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-300">
          <div>
            <div className="font-semibold mb-2">Timing Strategies:</div>
            <ul className="space-y-1 text-xs list-disc list-inside">
              <li>Convert in December (pay tax in April)</li>
              <li>Use market dips (convert more shares)</li>
              <li>Spread over multiple years to stay in lower brackets</li>
              <li>Start early (age 60-73 ideal window)</li>
            </ul>
          </div>
          <div>
            <div className="font-semibold mb-2">Paying Taxes:</div>
            <ul className="space-y-1 text-xs list-disc list-inside">
              <li>Pay tax from taxable account (not IRA)</li>
              <li>Preserve Roth principal for growth</li>
              <li>Quarterly estimates may be required</li>
              <li>Plan for {formatCurrency(summary.averageAnnualTax)}/year</li>
            </ul>
          </div>
        </div>
      </div>

      {/* Warning About Costs */}
      {summary.totalTaxes > 500000 && (
        <div className="bg-red-900/20 border border-red-600/30 rounded-lg p-4">
          <div className="flex items-center gap-3">
            <span className="text-2xl">‚ö†Ô∏è</span>
            <div>
              <h4 className="font-semibold text-red-400">Large Tax Investment Required</h4>
              <p className="text-sm text-slate-300 mt-1">
                Total tax cost of {formatCurrency(summary.totalTaxes)} is significant. Consider:
              </p>
              <ul className="text-xs text-slate-400 mt-2 space-y-1 ml-6 list-disc">
                <li>Extending conversion timeline to reduce annual tax burden</li>
                <li>Converting only a portion of Traditional IRA</li>
                <li>Ensuring sufficient liquidity to pay taxes from taxable accounts</li>
                <li>Consulting with a CPA for tax optimization</li>
              </ul>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default RothTab;
